<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Publish Article</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Georgia, serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      font-size: 16px;
    }
    .admin-nav {
      text-align: center;
      margin-bottom: 20px;
    }
    .admin-nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #B5281A; /* brand red */
    }

    /* Tag groups */
    .tag-groups {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 10px;
    }
    .tag-group {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
    }
    .tag-group h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .checkbox-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px 14px;
    }
    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
      font-weight: normal;
    }
    .inline-hint {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      display: block;
    }
    button[type="submit"] {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="admin-nav">
    <a href="admin.html">New Article</a>
    <a href="admin-manage.html">Manage Articles</a>
  </div>

  <h1>Publish New Article</h1>
  
<div id="auth-box" style="margin:16px 0; border:1px solid #ddd; padding:12px; border-radius:6px;">
  <p><strong>Sign in to publish</strong></p>
  <input type="email" id="loginEmail" placeholder="you@example.com" style="max-width:320px;">
  <button type="button" id="sendLink">Send magic sign-in link</button>
  <p id="authStatus" style="font-size:13px;color:#666;margin-top:8px;"></p>
</div>
  
<div id="admin-ui" style="display:none;">
  <form id="articleForm">
    <label for="title">Article Title:</label>
    <input type="text" id="title" required>

    <label for="author">Author:</label>
    <input type="text" id="author" required>
    <label for="authorPhoto">Author Photo URL (optional):</label>
<input type="url" id="authorPhoto" placeholder="https://…">

<label for="authorBio">Author Bio (optional):</label>
<textarea id="authorBio" rows="4" placeholder="Short bio shown on the author page."></textarea>

    <label for="image">Image URL:</label>
    <input type="url" id="image" placeholder="https://…">

    <label for="body">Article Content:</label>
    <textarea id="body" rows="10" required></textarea>

    <label for="date">Publication Date (optional):</label>
    <input type="date" id="date">

    <label>Tags (choose one or more):</label>
    <div class="tag-groups">
      <div class="tag-group">
        <h3>News</h3>
        <div class="checkbox-list">
          <label><input type="checkbox" name="tags" value="happening-now"> Happening Now</label>
          <label><input type="checkbox" name="tags" value="politics"> Politics</label>
          <label><input type="checkbox" name="tags" value="environment"> Environment</label>
          <label><input type="checkbox" name="tags" value="transportation"> Transportation</label>
          <label><input type="checkbox" name="tags" value="education"> Education</label>
        </div>
      </div>

      <div class="tag-group">
        <h3>Life & Culture</h3>
        <div class="checkbox-list">
          <label><input type="checkbox" name="tags" value="people"> People</label>
          <label><input type="checkbox" name="tags" value="events"> Events</label>
          <label><input type="checkbox" name="tags" value="reviews"> Reviews</label>
        </div>
      </div>

      <div class="tag-group">
        <h3>Opinion</h3>
        <div class="checkbox-list">
          <label><input type="checkbox" name="tags" value="opinion"> Opinion</label>
        </div>
        <span class="inline-hint">You can combine “Opinion” with other tags if appropriate.</span>
      </div>
    </div>

    <label>
      <input type="checkbox" id="editorsPick">
      Feature in Editor's Picks
    </label>

    <button type="submit">Publish Article</button>
  </form>
  </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://hnvcbrlyuytmawlpgaal.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhudmNicmx5dXl0bWF3bHBnYWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDI5NTYsImV4cCI6MjA3MTExODk1Nn0.Ik4LauJ_QOJGOo9ZOCbxmyldyqVtJy_PfCt-2rH4hLw';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

 <script>
  // ===== Auth UI =====
  async function refreshAuthUI() {
    const { data: { session } } = await supabase.auth.getSession();
    const signedIn = !!session;
    document.getElementById('auth-box').style.display = signedIn ? 'none' : 'block';
    document.getElementById('admin-ui').style.display = signedIn ? 'block' : 'none';
    document.getElementById('authStatus').textContent = signedIn ? '' : 'Not signed in.';
  }

  document.getElementById('sendLink').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) { alert('Enter your email'); return; }
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: window.location.href }
    });
    if (error) {
      alert('Error sending link: ' + error.message);
    } else {
      document.getElementById('authStatus').textContent =
        'Check your email for the sign-in link, then return to this page.';
    }
  });

  supabase.auth.onAuthStateChange((_event, _session) => {
    refreshAuthUI();
  });

  // Initial auth check
  refreshAuthUI();

  // ===== Helpers you already had =====
  function slugifyName(name) {
    return (name || '')
      .toLowerCase()
      .trim()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');
  }

  // ===== Publish handler (Supabase) =====
  document.getElementById('articleForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Collect selected tags (array) – this uses your existing checkboxes
    const tagChecks = Array.from(document.querySelectorAll('input[name="tags"]:checked'));
    const selectedTags = tagChecks.map(cb => cb.value);
    if (selectedTags.length === 0) {
      alert("Please select at least one tag.");
      return;
    }

    const title = document.getElementById('title').value.trim();
    const authorName = document.getElementById('author').value.trim();
    const authorPhoto = document.getElementById('authorPhoto')?.value.trim() || '';
    const authorBio   = document.getElementById('authorBio')?.value.trim() || '';
    const image = document.getElementById('image').value.trim();
    const body  = document.getElementById('body').value.trim();
    const customDate = document.getElementById('date').value;
    const editorsPick = document.getElementById('editorsPick').checked;

    if (!title || !authorName || !body) {
      alert('Title, Author, and Body are required.');
      return;
    }

    const authorSlug = slugifyName(authorName);
    const id = Date.now(); // keep using big timestamp IDs

    // 1) Upsert author
    {
      const { error: authErr } = await supabase
        .from('authors')
        .upsert({
          slug: authorSlug,
          name: authorName,
          photo: authorPhoto || null,
          bio: authorBio || null
        });
      if (authErr) {
        console.error(authErr);
        alert('Failed to save author: ' + authErr.message);
        return;
      }
    }

    // 2) Insert article
    {
      const { error: artErr } = await supabase
        .from('articles')
        .insert({
          id,
          title,
          author: authorName,
          author_slug: authorSlug,
          image: image || null,
          body,
          tags: selectedTags, // Supabase will store JS array into text[]
          timestamp: customDate ? new Date(customDate).toISOString() : new Date().toISOString(),
          views: 0,
          editors_pick: editorsPick
        });

      if (artErr) {
        console.error(artErr);
        alert('Failed to publish article: ' + artErr.message);
        return;
      }
    }

    alert('Article published!');
    this.reset();
  });
</script>
</body>
</html>
