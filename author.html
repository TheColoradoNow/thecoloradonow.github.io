<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Author</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Georgia, serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    .author-header {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
    }
    .author-header img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ddd;
    }
    .author-name {
      font-size: 1.8em;
      margin: 0 0 6px 0;
    }
    .author-bio { color: #444; }
    .article {
      border-bottom: 1px solid #eee;
      padding: 16px 0;
    }
    .article h2 {
      margin: 0 0 6px 0;
      font-size: 1.25em;
    }
    .meta {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    .article h2 a {
      color: inherit;
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .article h2 a:hover {
      color: #B5281A;
    }
    /* Reuse tag pills style for consistency */
    .tag-pills {
      margin: 6px 0 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tag-pill {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #B5281A;
      color: #B5281A;
      border-radius: 9999px;
      font-size: 0.85em;
      text-decoration: none;
      line-height: 1.2;
    }
    .tag-pill:hover { background: #B5281A; color: #fff; }
  </style>
</head>
<body>
  <h1 class="author-name" id="pageTitle" style="display:none;"></h1>

  <div class="author-header" id="authorHeader" style="display:none;">
    <img id="authorPhoto" alt="">
    <div>
      <div class="author-name" id="authorName"></div>
      <div class="author-bio" id="authorBio"></div>
    </div>
  </div>

  <div id="authorArticles"></div>

  <div class="all-articles-cta" style="margin-top: 30px;">
    <a href="all-articles.html" class="btn-pill">View All Articles</a>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://hnvcbrlyuytmawlpgaal.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhudmNicmx5dXl0bWF3bHBnYWFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NDI5NTYsImV4cCI6MjA3MTExODk1Nn0.Ik4LauJ_QOJGOo9ZOCbxmyldyqVtJy_PfCt-2rH4hLw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <script>
  (async function () {
    function slugifyName(name) {
      return (name || '')
        .toLowerCase()
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^a-z0-9-]/g, '');
    }

    const params = new URLSearchParams(window.location.search);
    const raw = params.get('author') || '';
    const authorSlug = decodeURIComponent(raw).toLowerCase();

    // Fetch author record
    const { data: authorRow, error: authorError } = await supabase
      .from('authors')
      .select('*')
      .eq('slug', authorSlug)
      .single();

    if (authorError) {
      console.error('Error loading author:', authorError);
    }

    const author = authorRow || null;

    // Fetch all articles (newest first)
    const { data: rows, error: articlesError } = await supabase
      .from('articles')
      .select('*')
      .order('timestamp', { ascending: false });

    if (articlesError) {
      console.error('Error loading articles:', articlesError);
    }

    const articles = rows || [];

    // Header elements
    const headerEl = document.getElementById('authorHeader');
    const photoEl = document.getElementById('authorPhoto');
    const nameEl = document.getElementById('authorName');
    const bioEl = document.getElementById('authorBio');
    const pageTitle = document.getElementById('pageTitle');
    const listEl = document.getElementById('authorArticles');

    if (!author && !articles.length) {
      document.body.insertAdjacentHTML('afterbegin', '<p>No author or articles found.</p>');
      return;
    }

    // Show author header (fallback to inferred name if missing in registry)
    const inferredName = (() => {
      const any = articles.find(a => (a.author_slug || slugifyName(a.author || '')) === authorSlug);
      return any?.author || authorSlug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    })();

    const displayName = author?.name || inferredName;
    const displayPhoto = author?.photo || 'images/author-placeholder.png';
    const displayBio = author?.bio || '';

    pageTitle.style.display = 'block';
    pageTitle.textContent = displayName;

    headerEl.style.display = 'grid';
    photoEl.src = displayPhoto;
    photoEl.alt = displayName;
    nameEl.textContent = displayName;
    bioEl.textContent = displayBio;

    // List articles for this author (by author_slug, fallback to name matching)
    const filtered = articles.filter(a => {
      const slug = a.author_slug || slugifyName(a.author || '');
      return slug === authorSlug;
    }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    if (!filtered.length) {
      listEl.innerHTML = '<p>No articles by this author yet.</p>';
      return;
    }

    filtered.forEach(article => {
      const tags = Array.isArray(article.tags)
        ? article.tags
        : (Array.isArray(article.tag) ? article.tag : (article.tag ? [article.tag] : []));
      const pillsHTML = tags.map(t => {
        const slug = String(t);
        const label = slug.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return \`<a class="tag-pill" href="tag.html?tag=\${encodeURIComponent(slug)}">\${label}</a>\`;
      }).join('');

      const dateStr = article.timestamp
        ? new Date(article.timestamp).toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' })
        : 'Unknown date';

      const excerpt = (article.body || '').split(' ').slice(0, 40).join(' ');

      const div = document.createElement('div');
      div.className = 'article';
      div.innerHTML = \`
        <h2><a href="article.html?id=\${article.id}">\${article.title}</a></h2>
        <div class="meta">Published \${dateStr}\${typeof article.views === 'number' ? \` â€” \${article.views} views\` : ''}</div>
        \${tags.length ? \`<div class="tag-pills">\${pillsHTML}</div>\` : ''}
        \${article.image ? \`<a href="article.html?id=\${article.id}"><img src="\${article.image}" alt="Image for \${article.title}" loading="lazy" style="max-width:100%;height:auto;margin:10px 0;"></a>\` : ''}
        <p>\${excerpt}...</p>
      \`;
      listEl.appendChild(div);
    });
  })();
  </script>
</body>
</html>
